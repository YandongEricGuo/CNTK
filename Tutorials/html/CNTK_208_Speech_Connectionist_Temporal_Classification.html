

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>CNTK 208: Training Acoustic Model with Connectionist Temporal Classification (CTC) Criteria &mdash; CNTK Tutorial Documentation  documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="CNTK Tutorial Documentation  documentation" href="index.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="tutindex.html" class="icon icon-home"> CNTK Tutorial Documentation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">CNTK 208: Training Acoustic Model with Connectionist Temporal Classification (CTC) Criteria</a><ul>
<li><a class="reference internal" href="#Introduction">Introduction</a></li>
<li><a class="reference internal" href="#Read-data">Read data</a></li>
<li><a class="reference internal" href="#Model-creation">Model creation</a><ul>
<li><a class="reference internal" href="#Define-training-hyperparameters">Define training hyperparameters</a></li>
</ul>
</li>
<li><a class="reference internal" href="#Train">Train</a></li>
<li><a class="reference internal" href="#Evaluate">Evaluate</a></li>
</ul>
</li>
</ul>
</div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="tutindex.html">CNTK Tutorial Documentation</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="tutindex.html">Docs</a> &raquo;</li>
        
      <li>CNTK 208: Training Acoustic Model with Connectionist Temporal Classification (CTC) Criteria</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/CNTK_208_Speech_Connectionist_Temporal_Classification.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 8ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-bold { font-weight: bold; }

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

/* nice headers on first paragraph of info/warning boxes */
.admonition .first {
    margin: -12px;
    padding: 6px 12px;
    margin-bottom: 12px;
    color: #fff;
    line-height: 1;
    display: block;
}
.admonition.warning .first {
    background: #f0b37e;
}
.admonition.note .first {
    background: #6ab0de;
}
.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}
</style>
<div class="section" id="CNTK-208:-Training-Acoustic-Model-with-Connectionist-Temporal-Classification-(CTC)-Criteria">
<h1>CNTK 208: Training Acoustic Model with Connectionist Temporal Classification (CTC) Criteria<a class="headerlink" href="#CNTK-208:-Training-Acoustic-Model-with-Connectionist-Temporal-Classification-(CTC)-Criteria" title="Permalink to this headline">¶</a></h1>
<p>This tutorial assumes familiarity with 10* CNTK tutorials and basic
knowledge of data representation in acoustic modelling tasks. It
introduces some CNTK building blocks that can be used in training deep
networks for speech recognition on the example of CTC training criteria.</p>
<div class="section" id="Introduction">
<h2>Introduction<a class="headerlink" href="#Introduction" title="Permalink to this headline">¶</a></h2>
<p>CNTK implementation of CTC is based on the paper by A. Graves et al.
<em>“Connectionist temporal classification: labeling unsegmented sequence
data with recurrent neural networks”</em>. CTC is a popular training
criteria for sequence learning tasks, such as speech or handwriting. It
doesn’t require segmentation of training data nor post-processing of
network outpus to convert them to labels. Thereby, it significantly
simplifies training and decoding processes while achieving state of the
art accuracy.</p>
<div class="line-block">
<div class="line">CTC training runs on several sequences in parallel either on GPU or
CPU, achieving maximal utilization of the hardware.</div>
<div class="line"><img alt="image0" src="http://cntk.ai/jup/cntk208_speech_image.png" /></div>
</div>
<p>First let us import some of the necessary libraries including CNTK and
setup the testing environment.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">cntk</span> <span class="kn">as</span> <span class="nn">C</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="c1"># Select the right target device</span>
<span class="kn">import</span> <span class="nn">cntk.tests.test_utils</span>
<span class="n">cntk</span><span class="o">.</span><span class="n">tests</span><span class="o">.</span><span class="n">test_utils</span><span class="o">.</span><span class="n">set_device_from_pytest_env</span><span class="p">()</span> <span class="c1"># (only needed for our build system)</span>

<span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;Tests&quot;</span><span class="p">,</span> <span class="s2">&quot;EndToEndTests&quot;</span><span class="p">,</span> <span class="s2">&quot;Speech&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;Current directory {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()))</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data_dir</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span> <span class="o">!=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Changed to data directory {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Data directory not available locally. Downloading data.&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlretrieve</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">urlretrieve</span>
    <span class="k">for</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;GlobalStats&#39;</span><span class="p">,</span> <span class="s1">&#39;Features&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="nb">dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span>
    <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;glob_0000.scp&#39;</span><span class="p">,</span> <span class="s1">&#39;glob_0000.write.scp&#39;</span><span class="p">,</span> <span class="s1">&#39;glob_0000.mlf&#39;</span><span class="p">,</span> <span class="s1">&#39;state_ctc.list&#39;</span><span class="p">,</span> <span class="s1">&#39;GlobalStats/mean.363&#39;</span><span class="p">,</span> <span class="s1">&#39;GlobalStats/var.363&#39;</span><span class="p">,</span> <span class="s1">&#39;Features/000000000.chunk&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Already downloaded </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Downloading </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">file</span><span class="p">)</span>
            <span class="n">urlretrieve</span><span class="p">(</span><span class="s1">&#39;https://github.com/Microsoft/CNTK/raw/release/2.1/Tests/EndToEndTests/Speech/Data/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">file</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Current directory D:\users\vadimma\cntk_tut\CNTK\Tutorials
Changed to data directory ..\Tests\EndToEndTests\Speech\Data
</pre></div></div>
</div>
</div>
<div class="section" id="Read-data">
<h2>Read data<a class="headerlink" href="#Read-data" title="Permalink to this headline">¶</a></h2>
<p>CNTK consumes Acoustic Model (AM) training data in HTK/MLF format and
typically expects 3 input files * <a class="reference external" href="https://github.com/Microsoft/CNTK/blob/master/Tests/EndToEndTests/Speech/Data/glob_0000.scp">SCP file with
features</a>.
SCP file contains mapping of utterance ids to corresponding feature
files. * <a class="reference external" href="https://github.com/Microsoft/CNTK/blob/master/Tests/EndToEndTests/Speech/Data/glob_0000.mlf">MLF file with
labels</a>.
MLF (master label file) is a traditional format for representing
transcription alignment to features. Even though the referenced MLF file
contains label boundaries, they are not needed during CTC training and
ignored. For more details on feature/label formats, refer to a copy of
HTK book, e.g.
<a class="reference external" href="http://www1.icsi.berkeley.edu/Speech/docs/HTKBook3.2/">here</a> *
<a class="reference external" href="https://github.com/Microsoft/CNTK/blob/master/Tests/EndToEndTests/Speech/Data/state_ctc.list">States list
file</a>.
This file contains the list of all labels (states) in the training set.
The blank label, required by CTC, is located in the end of the file at
index (line) 132, assuming 0-based indexing.</p>
<p>CNTK provides flexible and efficient readers
<code class="docutils literal"><span class="pre">HTKFeatureDeserializer</span></code>/<code class="docutils literal"><span class="pre">HTKMLFDeserializer</span></code> for acoustic features
and labels. These readers follow <a class="reference external" href="https://en.wikipedia.org/wiki/Convention_over_configuration">convention over configuration
principle</a>
and greatly simply training procedure. At the same time, they take care
of various optimizations of reading from disk/network, CPU and GPU
asynchronous prefetching which resuls in significant speed up of model
training.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Type of features/labels and dimensions are application specific</span>
<span class="c1"># Here we use rather small dimensional feature and the label set for the sake of keeping the train set compact.</span>
<span class="n">feature_dimension</span> <span class="o">=</span> <span class="mi">33</span>
<span class="n">feature</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">input</span><span class="p">((</span><span class="n">feature_dimension</span><span class="p">))</span>

<span class="n">label_dimension</span> <span class="o">=</span> <span class="mi">133</span>
<span class="n">label</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">input</span><span class="p">((</span><span class="n">label_dimension</span><span class="p">))</span>

<span class="n">train_feature_filepath</span> <span class="o">=</span> <span class="s2">&quot;glob_0000.scp&quot;</span>
<span class="n">train_label_filepath</span> <span class="o">=</span> <span class="s2">&quot;glob_0000.mlf&quot;</span>
<span class="n">mapping_filepath</span> <span class="o">=</span> <span class="s2">&quot;state_ctc.list&quot;</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">train_feature_stream</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">HTKFeatureDeserializer</span><span class="p">(</span>
    <span class="n">C</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">StreamDefs</span><span class="p">(</span><span class="n">speech_feature</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">StreamDef</span><span class="p">(</span><span class="n">shape</span> <span class="o">=</span> <span class="n">feature_dimension</span><span class="p">,</span> <span class="n">scp</span> <span class="o">=</span> <span class="n">train_feature_filepath</span><span class="p">)))</span>
    <span class="n">train_label_stream</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">HTKMLFDeserializer</span><span class="p">(</span>
    <span class="n">mapping_filepath</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">StreamDefs</span><span class="p">(</span><span class="n">speech_label</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">StreamDef</span><span class="p">(</span><span class="n">shape</span> <span class="o">=</span> <span class="n">label_dimension</span><span class="p">,</span> <span class="n">mlf</span> <span class="o">=</span> <span class="n">train_label_filepath</span><span class="p">)),</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">train_data_reader</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">MinibatchSource</span><span class="p">([</span><span class="n">train_feature_stream</span><span class="p">,</span> <span class="n">train_label_stream</span><span class="p">],</span> <span class="n">frame_mode</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">train_input_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">feature</span><span class="p">:</span> <span class="n">train_data_reader</span><span class="o">.</span><span class="n">streams</span><span class="o">.</span><span class="n">speech_feature</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="n">train_data_reader</span><span class="o">.</span><span class="n">streams</span><span class="o">.</span><span class="n">speech_label</span><span class="p">}</span>
<span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
    <span class="k">print</span> <span class="p">(</span><span class="s2">&quot;ERROR: not able to read features or labels&quot;</span><span class="p">)</span>

</pre></div>
</div>
</div>
</div>
<div class="section" id="Model-creation">
<h2>Model creation<a class="headerlink" href="#Model-creation" title="Permalink to this headline">¶</a></h2>
<p>In this block we first normalize the features and define a model with
LSTM Layers. We normalize the input features to zero mean and unit
variance by subtracting the mean vector and multiplying by
<a class="reference external" href="https://en.wikipedia.org/wiki/Multiplicative_inverse">inverse</a>
standard deviation, which are stored in separate files.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">feature_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;GlobalStats&quot;</span><span class="p">,</span> <span class="s2">&quot;mean.363&quot;</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">feature_dimension</span><span class="p">)</span>
<span class="n">feature_inverse_stddev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;GlobalStats&quot;</span><span class="p">,</span> <span class="s2">&quot;var.363&quot;</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">feature_dimension</span><span class="p">)</span>

<span class="n">feature_normalized</span> <span class="o">=</span> <span class="p">(</span><span class="n">feature</span> <span class="o">-</span> <span class="n">feature_mean</span><span class="p">)</span> <span class="o">*</span> <span class="n">feature_inverse_stddev</span>

<span class="k">with</span> <span class="n">C</span><span class="o">.</span><span class="n">default_options</span><span class="p">(</span><span class="n">activation</span><span class="o">=</span><span class="n">C</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">):</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
        <span class="n">C</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">For</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">C</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Recurrence</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">1024</span><span class="p">))),</span>
        <span class="n">C</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">label_dimension</span><span class="p">)</span>
    <span class="p">])(</span><span class="n">feature_normalized</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="Define-training-hyperparameters">
<h3>Define training hyperparameters<a class="headerlink" href="#Define-training-hyperparameters" title="Permalink to this headline">¶</a></h3>
<p>CTC criteria (loss) function is implemented by combination of the
<code class="docutils literal"><span class="pre">labels_to_graph</span></code> and <code class="docutils literal"><span class="pre">forward_backward</span></code> functions. These functions
are designed to generalize forward-backward viterbi-like functions which
are very common in sequential modelling problems, e.g. speech or
handwriting. <code class="docutils literal"><span class="pre">labels_to_graph</span></code> is designed to convert the input label
sequence into graph representation suitable for particular
forward-backward procedure, and <code class="docutils literal"><span class="pre">forward_backward</span></code> function performs
the procedure itself. Currently, these functions only support CTC, and
it’s their default configuration.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">mbsize</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">mbs_per_epoch</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">max_epochs</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">criteria</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">forward_backward</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">labels_to_graph</span><span class="p">(</span><span class="n">label</span><span class="p">),</span> <span class="n">z</span><span class="p">,</span> <span class="n">blankTokenId</span><span class="o">=</span><span class="mi">132</span><span class="p">,</span> <span class="n">delayConstraint</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">err</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">edit_distance_error</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">squashInputs</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">tokensToIgnore</span><span class="o">=</span><span class="p">[</span><span class="mi">132</span><span class="p">])</span>
<span class="c1"># Learning rate parameter schedule per sample:</span>
<span class="c1"># Use 0.01 for the first 3 epochs, followed by 0.001 for the remaining</span>
<span class="n">lr</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">learning_rate_schedule</span><span class="p">([(</span><span class="mi">3</span><span class="p">,</span> <span class="o">.</span><span class="mo">01</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">.</span><span class="mo">001</span><span class="p">)],</span> <span class="n">C</span><span class="o">.</span><span class="n">UnitType</span><span class="o">.</span><span class="n">sample</span><span class="p">)</span>
<span class="n">mm</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">momentum_schedule</span><span class="p">([(</span><span class="mi">1000</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">)],</span> <span class="n">mbsize</span><span class="p">)</span>
<span class="n">learner</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">momentum_sgd</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">mm</span><span class="p">)</span>
<span class="n">trainer</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="n">err</span><span class="p">),</span> <span class="n">learner</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="Train">
<h2>Train<a class="headerlink" href="#Train" title="Permalink to this headline">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">C</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">log_number_of_parameters</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
<span class="n">progress_printer</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">progress_print</span><span class="o">.</span><span class="n">ProgressPrinter</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s1">&#39;Training&#39;</span><span class="p">,</span> <span class="n">num_epochs</span> <span class="o">=</span> <span class="n">max_epochs</span><span class="p">)</span>

<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_epochs</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">mb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mbs_per_epoch</span><span class="p">):</span>
        <span class="n">minibatch</span> <span class="o">=</span> <span class="n">train_data_reader</span><span class="o">.</span><span class="n">next_minibatch</span><span class="p">(</span><span class="n">mbsize</span><span class="p">,</span> <span class="n">input_map</span> <span class="o">=</span> <span class="n">train_input_map</span><span class="p">)</span>
        <span class="n">trainer</span><span class="o">.</span><span class="n">train_minibatch</span><span class="p">(</span><span class="n">minibatch</span><span class="p">)</span>
        <span class="n">progress_printer</span><span class="o">.</span><span class="n">update_with_trainer</span><span class="p">(</span><span class="n">trainer</span><span class="p">,</span> <span class="n">with_metric</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Trained on a total of &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">total_number_of_samples_seen</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; frames&#39;</span><span class="p">)</span>
    <span class="n">progress_printer</span><span class="o">.</span><span class="n">epoch_summary</span><span class="p">(</span><span class="n">with_metric</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>

<span class="c1"># Uncomment to save the model</span>
<span class="c1"># z.save(&#39;CTC_&#39; + str(max_epochs) + &#39;epochs_&#39; + str(mbsize) + &#39;mbsize_&#39; + str(mbs_per_epoch) + &#39;mbs.model&#39;)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training 21255301 parameters in 11 parameter tensors.
Trained on a total of 8428 frames
Finished Epoch[1 of 5]: [Training] loss = 3.720116 * 8428, metric = 100.00% * 8428 25.106s (335.7 samples/s);
Trained on a total of 17094 frames
Finished Epoch[2 of 5]: [Training] loss = 3.513460 * 8666, metric = 98.07% * 8666 21.176s (409.2 samples/s);
Trained on a total of 25662 frames
Finished Epoch[3 of 5]: [Training] loss = 3.498874 * 8568, metric = 98.23% * 8568 21.978s (389.8 samples/s);
Trained on a total of 35282 frames
Finished Epoch[4 of 5]: [Training] loss = 3.512962 * 9620, metric = 98.23% * 9620 22.159s (434.1 samples/s);
Trained on a total of 43890 frames
Finished Epoch[5 of 5]: [Training] loss = 3.508142 * 8608, metric = 98.12% * 8608 19.864s (433.3 samples/s);
</pre></div></div>
</div>
</div>
<div class="section" id="Evaluate">
<h2>Evaluate<a class="headerlink" href="#Evaluate" title="Permalink to this headline">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">test_feature_filepath</span> <span class="o">=</span> <span class="s2">&quot;glob_0000.write.scp&quot;</span>
<span class="n">test_feature_stream</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">HTKFeatureDeserializer</span><span class="p">(</span>
    <span class="n">C</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">StreamDefs</span><span class="p">(</span><span class="n">speech_feature</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">StreamDef</span><span class="p">(</span><span class="n">shape</span> <span class="o">=</span> <span class="n">feature_dimension</span><span class="p">,</span> <span class="n">scp</span> <span class="o">=</span> <span class="n">test_feature_filepath</span><span class="p">)))</span>
<span class="n">test_data_reader</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">MinibatchSource</span><span class="p">([</span><span class="n">test_feature_stream</span><span class="p">,</span> <span class="n">train_label_stream</span><span class="p">],</span> <span class="n">frame_mode</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
<span class="n">test_input_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">feature</span><span class="p">:</span> <span class="n">test_data_reader</span><span class="o">.</span><span class="n">streams</span><span class="o">.</span><span class="n">speech_feature</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="n">test_data_reader</span><span class="o">.</span><span class="n">streams</span><span class="o">.</span><span class="n">speech_label</span><span class="p">}</span>

<span class="n">num_test_minibatches</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">test_result</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_test_minibatches</span><span class="p">):</span>
    <span class="n">test_minibatch</span> <span class="o">=</span> <span class="n">test_data_reader</span><span class="o">.</span><span class="n">next_minibatch</span><span class="p">(</span><span class="n">mbsize</span><span class="p">,</span> <span class="n">input_map</span> <span class="o">=</span> <span class="n">test_input_map</span><span class="p">)</span>
    <span class="n">eval_error</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">test_minibatch</span><span class="p">(</span><span class="n">test_minibatch</span><span class="p">)</span>
    <span class="n">test_result</span> <span class="o">=</span> <span class="n">test_result</span> <span class="o">+</span> <span class="n">eval_error</span>

<span class="c1"># Average of evaluation errors of all test minibatches</span>
<span class="nb">round</span><span class="p">(</span><span class="n">test_result</span> <span class="o">/</span> <span class="n">num_test_minibatches</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[6]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>0.99
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Cognitive Toolkit (CNTK) Team.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>